## å¼•è¨€

è¿™å‘¨å¶ç„¶åœ¨ CodePen ä¸Šåˆ·åˆ°ä¸€ä¸ªåä¸º â€œNovaâ€ çš„ 3D ç²’å­åŠ¨ç”»ï¼Œå±•ç¤ºä¸€ä¸ªæ˜Ÿäº‘æ•ˆæœï¼Œæå…¶é…·ç‚«ã€‚

![nova](https://cdn.jsdelivr.net/gh/amingdrift/picBed/img/blog%2Fnova.png)

äºæ˜¯æˆ‘ç«‹åˆ»â€œå€Ÿé‰´â€äº†ä»–çš„ä»£ç ï¼Œå¹¶èŠ±äº†ç‚¹æ—¶é—´è§£æå…¶åŸç†ã€‚ä»Šå¤©å°±å¸¦å¤§å®¶ä¸€æ­¥æ­¥æ‹†è§£è¿™ä¸ª 15 ä¸‡ä¸ªç²’å­çš„é«˜æ€§èƒ½åŠ¨ç”»ç³»ç»Ÿï¼Œçœ‹çœ‹ Three.js æ˜¯å¦‚ä½•å€ŸåŠ© GPU ç€è‰²å™¨ å®ç°å¦‚æ­¤æµç•…åˆå¤æ‚çš„è§†è§‰æ•ˆæœçš„ã€‚

> åŸä½œåœ°å€ï¼š[https://codepen.io/prisoner849/pen/RwyzrVj](https://codepen.io/prisoner849/pen/RwyzrVj)

## ä¸€ã€åŸºç¡€åœºæ™¯æ­å»ºï¼šç›¸æœºã€æ¸²æŸ“å™¨ä¸äº¤äº’

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹æœ€åŸºç¡€çš„ Three.js åœºæ™¯æ­å»ºéƒ¨åˆ†ï¼š

```js
import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls';
```

- ä½¿ç”¨ Skypack CDN åŠ è½½ Three.js v0.136.0 åŠå…¶ OrbitControlsï¼ˆç”¨äºé¼ æ ‡äº¤äº’æ§åˆ¶ç›¸æœºï¼‰ã€‚

```js
let scene = new THREE.Scene();
scene.background = new THREE.Color(0x160016); // æ·±ç´«è‰²èƒŒæ™¯

let camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 1, 1000);
camera.position.set(0, 4, 21);

let renderer = new THREE.WebGLRenderer();
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);
```

- åˆ›å»ºåœºæ™¯ã€ç›¸æœºï¼ˆé€è§†æŠ•å½±ï¼‰ã€æ¸²æŸ“å™¨ï¼Œå¹¶å°†æ¸²æŸ“å™¨æ·»åŠ åˆ°é¡µé¢ã€‚
- èƒŒæ™¯ä¸ºæ·±ç´«è‰²ï¼ˆ0x160016ï¼‰ã€‚
- ç›¸æœºåˆå§‹ä½ç½®åœ¨ (0, 4, 21)ï¼Œæœå‘åŸç‚¹ã€‚

### PerspectiveCamera å‚æ•°è¯¦è§£

æ ¹æ® [Three.js å®˜æ–¹æ–‡æ¡£](https://threejs.org/docs/#api/zh/cameras/PerspectiveCamera)ï¼Œ`PerspectiveCamera` æ„é€ å‡½æ•°çš„å››ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼š

- `fov`ï¼ˆField of Viewï¼‰ï¼š`60`  
   è¡¨ç¤ºç›¸æœºçš„å‚ç›´è§†è§’ï¼ˆå•ä½ï¼šåº¦ï¼‰ã€‚å€¼è¶Šå¤§ï¼Œçœ‹åˆ°çš„èŒƒå›´è¶Šå¹¿ï¼Œä½†ç‰©ä½“æ˜¾å¾—æ›´å°ã€‚60Â° æ˜¯ä¸€ä¸ªæ¥è¿‘äººçœ¼çš„è‡ªç„¶è§†è§’ã€‚
- `aspect`ï¼ˆå®½é«˜æ¯”ï¼‰ï¼š`innerWidth / innerHeight`  
   é€šå¸¸è®¾ä¸ºç”»å¸ƒçš„å®½é«˜æ¯”ï¼Œé¿å…ç”»é¢æ‹‰ä¼¸ã€‚
- `near`ï¼ˆè¿‘è£å‰ªé¢ï¼‰ï¼š`1`  
   è·ç¦»ç›¸æœºå°äº 1 çš„ç‰©ä½“å°†ä¸ä¼šè¢«æ¸²æŸ“ã€‚
- `far`ï¼ˆè¿œè£å‰ªé¢ï¼‰ï¼š`1000`  
   è·ç¦»ç›¸æœºå¤§äº 1000 çš„ç‰©ä½“å°†è¢«è£å‰ªæ‰ã€‚è¿™äº›å‚æ•°å…±åŒå®šä¹‰äº†ç›¸æœºçš„â€œå¯è§†é”¥ä½“â€ï¼ˆView Frustumï¼‰ã€‚

> ### `camera.position` ä¸åæ ‡ç³»
>
> camera.position.set(0, 4, 21) å°†ç›¸æœºæ”¾ç½®åœ¨ (x=0, y=4, z=21) çš„ä½ç½®ï¼Œå³æ­£å¯¹åœºæ™¯ä¸­å¿ƒã€ç•¥é«˜äºåŸç‚¹ã€è·ç¦»è¾ƒè¿œï¼Œé»˜è®¤å¯¹å‡†åŸç‚¹(0, 0, 0)ï¼Œé€‚åˆè§‚å¯Ÿæ•´ä¸ªç²’å­ç³»ç»Ÿã€‚
>
> - x è½´æ°´å¹³æ–¹å‘ä½ç½®ï¼ˆå·¦å³ç§»åŠ¨ï¼‰æ­£æ–¹å‘å‘å³ğŸ‘‰
> - y è½´å‚ç›´æ–¹å‘ä½ç½®ï¼ˆä¸Šä¸‹ç§»åŠ¨ï¼‰æ­£æ–¹å‘å‘ä¸ŠğŸ‘†
> - z è½´å‰åæ–¹å‘ä½ç½®ï¼ˆè¿œè¿‘ç§»åŠ¨ï¼‰æ­£æ–¹å‘å‘å‰ğŸ‘Š

```js
window.addEventListener('resize', (event) => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
});
```

- ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ŒåŠ¨æ€è°ƒæ•´ç›¸æœºå’Œæ¸²æŸ“å™¨å°ºå¯¸

```js
let controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.enablePan = false;
```

- å¯ç”¨è½¨é“æ§åˆ¶å™¨ï¼ˆå¯æ—‹è½¬/ç¼©æ”¾è§†è§’ï¼‰ï¼Œå¼€å¯é˜»å°¼æ•ˆæœï¼ˆå¹³æ»‘ç§»åŠ¨ï¼‰ï¼Œç¦ç”¨å¹³ç§»ï¼ˆpanï¼‰ã€‚

## äºŒã€ç²’å­æ•°æ®ç”Ÿæˆ

### 1. å®šä¹‰è¾…åŠ©å‡½æ•°å’Œæ•°ç»„

```js
let gu = {
    time: { value: 0 },
};
```

- gu æ˜¯ä¸€ä¸ª `uniform` å¯¹è±¡ï¼Œç”¨äºåœ¨ç€è‰²å™¨ä¸­ä¼ é€’æ—¶é—´å˜é‡ã€‚

```js
let sizes = [];
let shift = [];
let pushShift = () => {
    shift.push(
        Math.random() * Math.PI,
        Math.random() * Math.PI * 2,
        (Math.random() * 0.9 + 0.1) * Math.PI * 0.1,
        Math.random() * 0.9 + 0.1,
    );
};
```

- `sizes`ï¼šæ¯ä¸ªç²’å­çš„å°ºå¯¸ç¼©æ”¾å› å­ã€‚
- `shift`ï¼šæ¯ä¸ªç²’å­çš„åŠ¨ç”»å‚æ•°ï¼ˆ4ä¸ªå€¼ï¼‰ï¼š
    - `shift.x`ï¼šåˆå§‹ç›¸ä½è§’ï¼ˆç”¨äºæ—¶é—´åç§»ï¼‰
    - `shift.y`ï¼šå¦ä¸€ä¸ªç›¸ä½è§’
    - `shift.z`ï¼šåŠ¨ç”»é€Ÿåº¦ï¼ˆè§’é€Ÿåº¦ï¼‰
    - `shift.w`ï¼šæŒ¯å¹…ï¼ˆä½ç§»å¼ºåº¦ï¼‰

### 2. ä¸¤ç§ç©ºé—´åˆ†å¸ƒç­–ç•¥

æ•´ä¸ªåŠ¨ç”»åŒ…å« 15 ä¸‡ä¸ªç²’å­ï¼Œåˆ†ä¸ºä¸¤ç»„ç”Ÿæˆï¼š

### 1. çƒå£³åˆ†å¸ƒï¼ˆ5 ä¸‡ç²’å­ï¼‰

```js
let pts = new Array(50000).fill().map((p) => {
    sizes.push(Math.random() * 1.5 + 0.5);
    pushShift();
    return new THREE.Vector3().randomDirection().multiplyScalar(Math.random() * 0.5 + 9.5);
});
```

- `randomDirection()`ï¼šç”Ÿæˆä¸€ä¸ªå•ä½å‘é‡ï¼ˆé•¿åº¦ä¸º 1ï¼Œæ–¹å‘éšæœºï¼‰ã€‚
- `multiplyScalar(s)`ï¼šå°†å‘é‡çš„æ¯ä¸ªåˆ†é‡ä¹˜ä»¥æ ‡é‡ sï¼Œä»è€Œç¼©æ”¾å…¶é•¿åº¦ã€‚
- æœ€ç»ˆç²’å­åˆ†å¸ƒåœ¨åŠå¾„çº¦ 9.5 ~ 10 çš„çƒå£³ä¸Šã€‚

æ•ˆæœï¼šç”Ÿæˆ 50,000 ä¸ªç²’å­ï¼Œåˆ†å¸ƒåœ¨ä¸€ä¸ªåŠå¾„çº¦ 9.5~10 çš„çƒå£³ä¸Šï¼ˆéšæœºæ–¹å‘ Ã— éšæœºåŠå¾„ï¼‰ã€‚

### 2. è–„çŠ¶åœ†æŸ±å£³ï¼ˆæ˜Ÿç¯ï¼‰åˆ†å¸ƒï¼ˆ10 ä¸‡ç²’å­ï¼‰

```js
for (let i = 0; i < 100000; i++) {
    let r = 10,
        R = 40;
    let rand = Math.pow(Math.random(), 1.5);
    let radius = Math.sqrt(R * R * rand + (1 - rand) * r * r);
    pts.push(
        new THREE.Vector3().setFromCylindricalCoords(
            radius,
            Math.random() * 2 * Math.PI,
            (Math.random() - 0.5) * 2,
        ),
    );
    sizes.push(Math.random() * 1.5 + 0.5);
    pushShift();
}
```

- å†ç”Ÿæˆ 100,000 ä¸ªç²’å­ï¼Œåˆ†å¸ƒåœ¨å†…å¤–åŠå¾„ä¸º `10~40` çš„åœ†æŸ±å£³å†…ï¼ˆZ èŒƒå›´ `-1~1`ï¼‰ã€‚
- `setFromCylindricalCoords(radius, theta, y)` æ˜¯ Three.js æä¾›çš„ä¾¿æ·æ–¹æ³•ï¼Œç”¨äºä»æŸ±åæ ‡è½¬æ¢ä¸ºç¬›å¡å°”åæ ‡ï¼š
    - `radius`ï¼šåˆ° Z è½´çš„è·ç¦»ï¼ˆå¾„å‘ï¼‰
    - `theta`ï¼šç»• Z è½´çš„è§’åº¦ï¼ˆå¼§åº¦ï¼‰
    - `y`ï¼šé«˜åº¦ï¼ˆZ è½´æ–¹å‘ï¼‰
- è¿™é‡Œé€šè¿‡ `Math.sqrt(...)` å®ç°åœ¨å†…å¤–åŠå¾„ [10, 40] ä¹‹é—´çš„éå‡åŒ€åˆ†å¸ƒï¼Œä½¿ç²’å­æ›´å¯†é›†äºå†…åœˆï¼Œè§†è§‰ä¸Šæ›´æœ‰å±‚æ¬¡ã€‚ (æ•°å­¦æŠ€å·§ï¼Œç”±é¢ç§¯å‡åŒ€åˆ†å¸ƒçš„äº§ç”Ÿçš„å˜ä½“ï¼Œåå‘å†…åœˆçš„**éå‡åŒ€åˆ†å¸ƒ**ï¼Œè¿™é‡Œä¸æ·±ç©¶äº†)ã€‚

## ä¸‰ã€å‡ ä½•ä½“ä¸æè´¨ï¼š`BufferGeometry` ä¸ `PointsMaterial`

### `BufferGeometry`ï¼šé«˜æ•ˆå­˜å‚¨é¡¶ç‚¹æ•°æ®

```js
let g = new THREE.BufferGeometry().setFromPoints(pts);
g.setAttribute('sizes', new THREE.Float32BufferAttribute(sizes, 1));
g.setAttribute('shift', new THREE.Float32BufferAttribute(shift, 4));
```

- `BufferGeometry` æ˜¯ Three.js ä¸­æœ€é«˜æ•ˆçš„å‡ ä½•ä½“ç±»å‹ï¼Œç›´æ¥æ“ä½œ GPU ç¼“å†²åŒºã€‚
- `setFromPoints(pts)` å°† Vector3 æ•°ç»„è½¬æ¢ä¸º position attributeã€‚
- setAttribute ç”¨äºæ·»åŠ è‡ªå®šä¹‰ attributeï¼š
    - `sizes`ï¼šæ¯ä¸ªç²’å­çš„å°ºå¯¸ç¼©æ”¾å› å­ï¼ˆ1 ä¸ª floatï¼‰
    - `shift`ï¼šæ¯ä¸ªç²’å­çš„åŠ¨ç”»å‚æ•°ï¼ˆ4 ä¸ª floatï¼Œå¯¹åº” vec4ï¼‰

> è¿™äº› attribute ä¼šåœ¨é¡¶ç‚¹ç€è‰²å™¨ä¸­è¢«è¯»å–ï¼Œå®ç° per-particleï¼ˆé€ç²’å­ï¼‰æ§åˆ¶ã€‚

### `PointsMaterial`ï¼šä¸“ä¸ºç‚¹ç²¾çµè®¾è®¡çš„æè´¨

```js
let m = new THREE.PointsMaterial({
    size: 0.125,
    transparent: true,
    depthTest: false,
    blending: THREE.AdditiveBlending,
});
```

- `size`  
   åŸºç¡€ç‚¹å¤§å°ï¼ˆå•ä½ï¼šä¸–ç•Œåæ ‡ï¼‰ã€‚
- `transparent: true`  
   å¯ç”¨é€æ˜åº¦ã€‚
- `depthTest: false`  
   å…³é—­æ·±åº¦æµ‹è¯•ï¼Œé¿å…è¿œå¤„ç²’å­è¢«è¿‘å¤„ç²’å­é®æŒ¡ï¼Œç¡®ä¿æ‰€æœ‰ç²’å­å¯è§ï¼ˆé€‚åˆæ˜Ÿäº‘æ•ˆæœï¼‰ã€‚
- `blending: AdditiveBlending`  
   ä½¿ç”¨åŠ æ³•æ··åˆï¼Œå¤šä¸ªç²’å­é‡å æ—¶äº®åº¦å åŠ ï¼Œäº§ç”Ÿâ€œå‘å…‰â€æ•ˆæœã€‚

## \*å››ã€é€šè¿‡ `onBeforeCompile` æ³¨å…¥è‡ªå®šä¹‰ç€è‰²å™¨é€»è¾‘

Three.js çš„å†…ç½®æè´¨ï¼ˆå¦‚ PointsMaterialï¼‰è™½ç„¶æ–¹ä¾¿ï¼Œä½†æ— æ³•ç›´æ¥è®¿é—®è‡ªå®šä¹‰ attribute æˆ–å®ç°å¤æ‚åŠ¨ç”»é€»è¾‘ã€‚è¿™æ—¶å°±éœ€è¦ `onBeforeCompile`ã€‚

> å®˜æ–¹æ–‡æ¡£è¯´æ˜ `onBeforeCompile` å…è®¸æˆ‘ä»¬åœ¨æè´¨ç¼–è¯‘ä¸º WebGL ç€è‰²å™¨ä¹‹å‰ï¼ŒåŠ¨æ€ä¿®æ”¹å…¶é¡¶ç‚¹/ç‰‡å…ƒç€è‰²å™¨ä»£ç ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒ

1. æ³¨å…¥è‡ªå®šä¹‰ `uniformï¼štime`ï¼ˆç”¨äºé©±åŠ¨åŠ¨ç”»ï¼‰
2. æ³¨å…¥è‡ªå®šä¹‰ `attributeï¼šsizes` å’Œ `shift`
3. é‡å†™å…³é”®ç€è‰²å™¨ç‰‡æ®µï¼šæ›¿æ¢ `gl_PointSize`ã€`color_vertex`ã€`begin_vertex` ç­‰å†…ç½®ä»£ç å—

### è‡ªå®šä¹‰ç€è‰²å™¨é‡Œä¼ é€’ Uniform å˜é‡

```js
shader.uniforms.time = gu.time; // æ·»åŠ  uniform
```

- å°†åä¸º `time` çš„ `Uniform` å˜é‡ç»‘å®šåˆ°è¿™ä¸ªå¯¹è±¡ä¸Šï¼ŒThree.js ä¼šåœ¨æ¸²æŸ“æ—¶è‡ªåŠ¨æŠŠ `gu.time.value` ä¼ ç»™ GPU
- è¿™è¡Œä»£ç æ˜¯è¿æ¥ CPU ä¸ GPU çš„æ¡¥æ¢ï¼Œè®© JavaScript èƒ½å¤Ÿå®æ—¶æ§åˆ¶ç€è‰²å™¨çš„è¡Œä¸ºï¼Œæ˜¯å®ç°åŠ¨æ€è§†è§‰æ•ˆæœï¼ˆå¦‚æµåŠ¨ã€è„‰åŠ¨ã€å˜å½¢ç­‰ï¼‰çš„æ ¸å¿ƒæœºåˆ¶ã€‚

### é¡¶ç‚¹ç€è‰²å™¨ï¼ˆ`Vertex Shader`ï¼‰ä¿®æ”¹

```js
shader.vertexShader = `...`.replace(...); // ä¿®æ”¹é¡¶ç‚¹ç€è‰²å™¨
```

> è¿™æ˜¯ Three.js ä¸­å®ç°é«˜çº§è‡ªå®šä¹‰æ•ˆæœçš„æ ‡å‡†åšæ³•ï¼Œæ—¢ä¿ç•™äº†æè´¨çš„ä¾¿åˆ©æ€§ï¼Œåˆè·å¾—äº†ç€è‰²å™¨çš„å®Œå…¨æ§åˆ¶æƒã€‚

```GLSL
+   uniform float time;
+   attribute float sizes;
+   attribute vec4 shift;
+   varying vec3 vColor;
```

- å£°æ˜ uniformï¼Œattributeï¼Œvarying å˜é‡

```GLSL
-   gl_PointSize = size;
+   gl_PointSize = size * sizes;
```

- æ¯ä¸ªç²’å­çš„å®é™…å¤§å° = åŸºç¡€ size Ã— è‡ªå®šä¹‰ sizesã€‚

> è®©ç‚¹çš„å¤§å°ç”± â€œå•ä¸€å˜é‡ size æ§åˆ¶â€ å˜ä¸º â€œä¸¤ä¸ªå˜é‡ size å’Œ sizes çš„ä¹˜ç§¯æ§åˆ¶â€ï¼Œå®ç°æ›´çµæ´»çš„ç‚¹å¤§å°è°ƒèŠ‚ï¼ˆè®©ä¸åŒç‚¹æ ¹æ® sizes å˜é‡å‘ˆç°ä¸åŒå¤§å°ï¼Œå®ç° â€œç‚¹äº‘å¤§å°å·®å¼‚åŒ–â€ ï¼‰ã€‚

#### ç²’å­é¢œè‰²

```GLSL
    #include <color_vertex>
+   float d = length(abs(position) / vec3(40., 10., 40));
+   d = clamp(d, 0., 1.);
+   vColor = mix(vec3(227., 155., 0.), vec3(100., 50., 255.), d) / 255.;
```

- æ ¹æ®ç²’å­åœ¨ç©ºé—´ä¸­çš„å½’ä¸€åŒ–ä½ç½®ï¼ˆx/40, y/10, z/40ï¼‰è®¡ç®—è·ç¦» dã€‚
- ç”¨ mix åœ¨æ©™è‰² (227,155,0) å’Œç´«è‰² (100,50,255) ä¹‹é—´æ’å€¼ï¼Œç”Ÿæˆé¢œè‰²ã€‚
- é™¤ä»¥ 255 æ˜¯å› ä¸º Three.js é»˜è®¤é¢œè‰²èŒƒå›´æ˜¯ 0~1ã€‚

#### ç²’å­åŠ¨ç”»çš„ç§˜å¯†

```GLSL
    #include <begin_vertex>
+   float t = time;
+   float moveT = mod(shift.x + shift.z * t, PI2);
+   float moveS = mod(shift.y + shift.z * t, PI2);
+   transformed += vec3(cos(moveS) * sin(moveT), cos(moveT), sin(moveS) * sin(moveT)) * shift.w;
```

- `shift.x`, `shift.y`ï¼šæ¯ä¸ªç²’å­çš„åˆå§‹ç›¸ä½ï¼ˆéšæœºå€¼ï¼‰
- `shift.z`ï¼šè§’é€Ÿåº¦ï¼ˆæ§åˆ¶åŠ¨ç”»å¿«æ…¢ï¼‰
- `shift.w`ï¼šæŒ¯å¹…ï¼ˆæ§åˆ¶æŠ–åŠ¨å¹…åº¦ï¼‰
- `vec3(...)`ï¼šè®¡ç®—å•ä½çƒé¢ä¸Šçš„ä¸€ä¸ªç‚¹ï¼ˆçƒåæ ‡è½¬ç¬›å¡å°”ï¼‰
- æœ€ç»ˆå°†è¿™ä¸ªåç§»é‡åŠ åˆ°åŸå§‹ä½ç½®ä¸Šï¼Œå½¢æˆå›´ç»•åŸç‚¹çš„å‘¨æœŸæ€§æ‰°åŠ¨

> æ‰€æœ‰ç²’å­ä»¥ä¸åŒèŠ‚å¥â€œå‘¼å¸â€ï¼Œè¥é€ å‡ºâ€œæ´»â€çš„æ˜Ÿäº‘æ„Ÿã€‚

### ç‰‡å…ƒç€è‰²å™¨ï¼ˆ`Fragment Shader`ï¼‰ä¿®æ”¹

ç‰‡å…ƒç€è‰²å™¨è´Ÿè´£å†³å®šæ¯ä¸ªåƒç´ çš„é¢œè‰²å’Œé€æ˜åº¦ã€‚é»˜è®¤çš„ PointsMaterial ä¼šæ¸²æŸ“ä¸€ä¸ªå®å¿ƒæ–¹å½¢ç‚¹ï¼Œä½†æˆ‘ä»¬æƒ³è¦çš„æ˜¯æŸ”å’Œå‘å…‰çš„åœ†å½¢ç²’å­ã€‚

```GLSL
    #include <clipping_planes_fragment>
+   float d = length(gl_PointCoord.xy - 0.5);
```

- è®¡ç®—å½“å‰ç‰‡å…ƒåˆ°ç²’å­ä¸­å¿ƒçš„è·ç¦»ï¼ˆgl_PointCoord æ˜¯ 0~1 çš„çº¹ç†åæ ‡ï¼‰ã€‚

```GLSL
-   vec4 diffuseColor = vec4( diffuse, opacity );
+   vec4 diffuseColor = vec4( vColor, smoothstep(0.5, 0.1, d)/* * 0.5 + 0.5*/ );
```

- `gl_PointCoord`ï¼šå†…ç½®å˜é‡ï¼Œè¡¨ç¤ºå½“å‰ç‰‡å…ƒåœ¨ç‚¹ç²¾çµä¸­çš„å½’ä¸€åŒ–åæ ‡ï¼ˆ0~1ï¼‰
- ä½¿ç”¨ `smoothstep(0.5, 0.1, d)` å®ç°ä»ä¸­å¿ƒå‘å¤–å¹³æ»‘è¡°å‡çš„é€æ˜åº¦ï¼š
    - å½“ d < 0.1 â†’ alpha â‰ˆ 1
    - å½“ d > 0.5 â†’ alpha â‰ˆ 0
    - ä¸­é—´å¹³æ»‘è¿‡æ¸¡ï¼Œå½¢æˆ**æŸ”å’Œå‘å…‰åœ†ç‚¹**ã€‚

> è¿™æ ·å°±å¾—åˆ°äº†è¾¹ç¼˜æŸ”å’Œã€ä¸­å¿ƒæ˜äº®çš„åœ†å½¢å…‰ç‚¹ï¼Œé…åˆ `AdditiveBlending`ï¼Œæ•ˆæœæå…¶æ¢¦å¹»ã€‚

## äº”ã€åœºæ™¯æ·»åŠ ä¸åŠ¨ç”»å¾ªç¯

```js
let p = new THREE.Points(g, m);
p.rotation.order = 'ZYX';
p.rotation.z = 0.2;
scene.add(p);
```

- åˆ›å»º `Points` å¯¹è±¡ï¼Œè®¾ç½®æ—‹è½¬é¡ºåºï¼ˆé¿å…ä¸‡å‘èŠ‚é”ï¼‰ï¼Œåˆå§‹ç»• Z è½´å€¾æ–œ 0.2 å¼§åº¦ã€‚

```js
let clock = new THREE.Clock();

renderer.setAnimationLoop(() => {
    controls.update();
    let t = clock.getElapsedTime() * 0.5;
    gu.time.value = t * Math.PI;
    p.rotation.y = t * 0.05;
    renderer.render(scene, camera);
});
```

- ä½¿ç”¨ `Clock` è·å–ç»è¿‡æ—¶é—´ã€‚
- `gu.time.value` ä¼ é€’ç»™ç€è‰²å™¨ï¼ˆé©±åŠ¨ç²’å­åŠ¨ç”»ï¼‰ã€‚
- æ•´ä¸ªç²’å­ç³»ç»Ÿç¼“æ…¢ç»• Y è½´æ—‹è½¬ï¼ˆ`p.rotation.y += ...`ï¼‰ï¼Œå¢å¼ºåŠ¨æ€æ„Ÿã€‚
- `controls.update()` æ›´æ–°è½¨é“æ§åˆ¶å™¨é˜»å°¼ã€‚

## å…­ã€æ€»ç»“ä¸å¯ç¤º

è¿™ä¸ªâ€œNovaâ€ç²’å­ç³»ç»Ÿå±•ç¤ºäº† Three.js çš„å¼ºå¤§ä¹‹å¤„ï¼š

- é«˜æ€§èƒ½ï¼š15 ä¸‡ç²’å­å…¨ç”± **GPU** é©±åŠ¨ï¼Œæ—  CPU è´Ÿæ‹…
- çµæ´»æ€§ï¼šé€šè¿‡ `onBeforeCompile` å®ç°ä»»æ„ç€è‰²å™¨é€»è¾‘
- è‰ºæœ¯æ€§ï¼šé¢œè‰²ã€åˆ†å¸ƒã€åŠ¨ç”»çš„ç²¾å¿ƒè®¾è®¡ï¼Œè§†è§‰æ•ˆæœğŸ‚ğŸº

> å­¦ä¹ ä¼˜ç§€ä½œå“ï¼Œæ˜¯æå‡æŠ€æœ¯çš„æœ€ä½³è·¯å¾„ã€‚å¸Œæœ›è¿™ç¯‡è§£æå¯¹ä½ æœ‰æ‰€å¸®åŠ©

å‚è€ƒèµ„æ–™ï¼š

- [https://codepen.io/prisoner849/pen/RwyzrVj](https://codepen.io/prisoner849/pen/RwyzrVj)
- [Three.js å®˜æ–¹æ–‡æ¡£](https://threejs.org/docs/)
- [OrbitControls](https://threejs.org/docs/#examples/zh/controls/OrbitControls)
- [BufferGeometry](https://threejs.org/docs/#api/zh/core/BufferGeometry)
- [PointsMaterial](https://threejs.org/docs/#api/zh/materials/PointsMaterial)
